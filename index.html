<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=0.8">
  <title>rakAI-chatbot</title>
  <link rel="stylesheet" href="style/general.css">
  <link rel="stylesheet" href="style/main.css">
</head>
<body>
  <main class="js-main">
  </main>
</body>
<script src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://unpkg.com/supersimpledev@8.0.1/chatbot.js"></script>

<script type="text/babel"> 
  const mainContainer = document.querySelector('.js-main');
  const rootHeader = ReactDOM.createRoot(mainContainer);
                                                      // <---- Chat Input Head --->
  function ChatInput({ chatMessages , setChatMessage }) {
    // 1.get the Input value and save it in inputText
    const [ inputText , setInputText ] = React.useState('');
    const [ isLoading , setIsLoading ] = React.useState(false);      
    function handleKeyDown( event ) {
      if( event.key === 'Enter' ) sendMessage();
      if( event.key === 'Escape' ) setInputText('');
    };
    function saveInputText( event ) {
      setInputText( event.target.value );
    };
    // 2.from the InpuText value --> send it into chatMessages(message array)
    async function sendMessage() {
      if( inputText === '' ) {
        alert('Invalid, maybe type something...');
        return;
      };
      if( isLoading === true ) {
        return;
      };
      setInputText('');
      setIsLoading(true);
      const newChatMessage = [
        ...chatMessages,
        {
          message : inputText,
          sender : 'user',
          id : crypto.randomUUID()
        }
      ] 
      setChatMessage( newChatMessage );
      setChatMessage([
        ...newChatMessage,
        {
          message : "Thinking..",
          sender : 'bot',
          id : crypto.randomUUID()
        }
      ]);
      const response = await Chatbot.getResponseAsync( inputText );        
      setChatMessage([
        ...newChatMessage,
        {
          message : response,
          sender : 'bot',
          id : crypto.randomUUID()
        }
      ]);
      setIsLoading(false);
    }
    return (
      <section className = "hero-head-container">
        <input 
          onChange = { saveInputText } 
          placeholder="Look up here.." 
          size="40"
          value  = { inputText } // this change the input value after whatever is saved inside the inputText
          onKeyDown = { handleKeyDown }
          className = "chat-input"
        />
        <button
          onClick = { sendMessage }  
          disabled = { isLoading }
        >
          { isLoading ? 'Sending' : 'Send' }
        </button>
      </section>
    );
  };
                                              // <------ Message Component ----->
  function ChatMessages({ chatMessages }) {
    const chatMessagesRef = React.useRef(null); //initial value is 'null'

    React.useEffect( () => {
      const containerElement = chatMessagesRef.current;
      if( containerElement ) {
        containerElement.scrollTop = containerElement.scrollHeight 
      }
    }, [ chatMessages ]);
    //const message = properties.message;
    //const sender = properties.sender;
    //const { message , sender } = properties;
    function ChatMessage({ message , sender }) {
      return (
        <div className={ sender === "user" ? "chatMsg-container-user" : "chatMsg-container-bot" }>
          { sender === "bot" && <img className="chat-image" src="images/bot.png"/>} 
          <div className="chat-message">
            { message }
          </div>
          { sender === "user" && <img className="chat-image" src="images/user.png"/>}
        </div>
      );
    };
    return (
      <section className="hero-chatmssg-container" ref={ chatMessagesRef }>
        {
          chatMessages.map( (chat) => {
            return (
              <ChatMessage
                message = {chat.message}
                sender = {chat.sender}
                key = {chat.id}
              />
            ); 
          })}
      </section>
    );
  };
                                                // <--------- App ------->
  function App() {
    // message array - chatMessages
    const [ chatMessages , setChatMessage ] = React.useState([
      {
        message : "Hey!. How are you?",
        sender : "user",
        id : 'id1'
      },
      {
        message : "Yeah I am good. How are you?",
        sender : "bot",
        id : 'id2'
      },
      {
        message : "Great. Its been long just wanted to catch up?. How you have been? whats going on?",
        sender : "user",
        id : 'id3'
      },
      {
        message : "Doing alright. Just working yk and went on a trip to Alaska",
        sender : "bot",
        id : 'id4'
      }
    ]);
    //const chatMessages = array[0];
    //const setChatMessage = array[1];
    return (
      <>
      <ChatMessages 
      chatMessages = { chatMessages }
      />
      <ChatInput 
        chatMessages = { chatMessages }
        setChatMessage = { setChatMessage }
      />
      </>
    );
  };
  rootHeader.render(<App/>);
</script>
</html>